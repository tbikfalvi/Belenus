//====================================================================================
//
// Belenus Kliens alkalmazas (c) Pagony Multimedia Studio Bt - 2010
//
//====================================================================================
//
// Filename    : wndmain.cpp
// AppVersion  : 1.0
// FileVersion : 1.0
// Author      : Ballok Peter, Bikfalvi Tamas
//
//====================================================================================
// Alkalmazas fo ablakat kezelo allomany.
//====================================================================================

#include <QMessageBox>
#include <QCryptographicHash>
#include <QProcess>

#include "wndmain.h"
#include "licenceManager.h"
#include "../framework/logger/DatabaseWriter.h"
#include "cdlgtest.h"
#include "belenus.h"

//====================================================================================

#include "db/dbpatientcard.h"
#include "db/dbledger.h"
#include "db/dbshoppingcart.h"
#include "db/dbpatientcardunits.h"
#include "db/dbdiscount.h"

//====================================================================================

#include "crud/dlgpaneltypes.h"
#include "crud/dlgpatientorigin.h"
#include "crud/dlgreasontovisit.h"
#include "crud/dlgusers.h"
#include "crud/dlgguest.h"
#include "crud/dlgpatientselect.h"
#include "crud/dlgpanelstatuses.h"
#include "crud/dlgpatientcardtype.h"
#include "crud/dlgpatientcard.h"
#include "crud/dlgpanelsettings.h"
#include "crud/dlgpaneluseselect.h"
#include "crud/dlgcompany.h"
#include "crud/dlgzipregioncity.h"
#include "crud/dlgdiscount.h"
#include "crud/dlgproducttype.h"
#include "crud/dlgproductactiontype.h"
#include "crud/dlgproduct.h"
#include "crud/dlgshoppingcart.h"
#include "crud/dlgproductsell.h"
#include "crud/dlgstorno.h"
#include "crud/dlgpaymentmethod.h"

//====================================================================================

#include "edit/dlguseredit.h"
#include "edit/dlgguestedit.h"
#include "edit/dlgpatientcardedit.h"
#include "edit/dlgpatientcardsell.h"
#include "edit/dlgpatientcardrefill.h"
#include "edit/dlgcassaedit.h"
#include "edit/dlgpatientcarduse.h"
#include "edit/dlglicenceedit.h"

//====================================================================================

#include "dlg/dlglogin.h"
#include "dlg/dlgpreferences.h"
#include "dlg/dlghardwaretest.h"
#include "dlg/dlglogs.h"
#include "dlg/dlginputstart.h"
#include "dlg/dlgpatientcardadd.h"
#include "dlg/dlgserialreg.h"
#include "dlg/dlgcassaaction.h"
#include "dlg/dlgpaneluse.h"
#include "dlg/dlgpatientcardassign.h"

//====================================================================================

#include "report/repledgermain.h"
#include "report/repcassalist.h"
#include "report/repcarduses.h"
#include "report/reppatientcards.h"
#include "report/reppatientcardsobs.h"

//====================================================================================

extern DatabaseWriter g_obLogDBWriter;
//extern LicenceManager g_obLicenceManager;

//====================================================================================
cWndMain::cWndMain( QWidget *parent ) : QMainWindow( parent )
{
    cTracer obTrace( "cWndMain::cWndMain" );

    setupUi( this );

    m_qsStatusText                  = "";
    m_bCtrlPressed                  = false;
    m_bSerialRegistration           = false;
    m_inRegistrationTimeout         = 0;
    m_bGlobalDataRequested          = false;
    m_inGlobalDataRequestTimeout    = 0;
    m_uiPatientId                   = 0;
    m_nEnterAction                  = 0;

    pbLogin->setIcon( QIcon("./resources/40x40_ok.png") );

    frmLogin->setVisible( false );
    frmLogin->setEnabled( false );

    m_dlgProgress = new cDlgProgress( this );

    mdiPanels = new cMdiPanels( centralwidget );
    verticalLayout->addWidget(mdiPanels);
    mdiPanels->setEnabled( false );

    mdiPanels->setBackground( QBrush( QColor( g_poPrefs->getMainBackground() ) ) );

    connect( mdiPanels, SIGNAL( activePanelChanged() ),                  this, SLOT( updateToolbar() ) );
    connect( mdiPanels, SIGNAL( signalOpenShoppingCart( uint ) ),        this, SLOT( slotOpenShoppingCart( uint )) );
    connect( mdiPanels, SIGNAL( signalPaymentActivated() ),              this, SLOT( on_action_PayCash_triggered() ) );
    connect( mdiPanels, SIGNAL( signalOpenScheduleTable(uint) ),         this, SLOT( slotOpenScheduleTable(uint)) );
    connect( mdiPanels, SIGNAL( signalStatusChanged(uint,uint,QString)), this, SLOT( slotStatusChanged(uint,uint,QString)) );
    connect( mdiPanels, SIGNAL( signalSetCounterText(uint,QString) ),    this, SLOT( slotSetCounterText(uint,QString) ) );
    connect( mdiPanels, SIGNAL( signalSetWaitTime(uint,uint) ),          this, SLOT( slotSetWaitTime(uint,uint) ) );
    connect( mdiPanels, SIGNAL( signalSetInfoText(uint,QString) ),       this, SLOT( slotSetInfoText(uint,QString) ) );

    updateTitle();
    setWindowIcon( QIcon("./resources/belenus.ico") );

    //--------------------------------------------------------------------------------
    // Toolbar buttons
    //--------------------------------------------------------------------------------
    action_Exit->setIcon( QIcon("./resources/40x40_shutdown.png") );
    action_LogOut->setIcon( QIcon("./resources/40x40_lock.png") );

    action_PatientSelect->setIcon( QIcon("./resources/40x40_patient_select.png") );
    action_PatientEmpty->setIcon( QIcon("./resources/40x40_patient_deselect.png") );
    action_EditActualPatient->setIcon( QIcon("./resources/40x40_patient_edit.png") );
    action_PatientNew->setIcon( QIcon("./resources/40x40_patient_new.png") );

    action_UseDevice->setIcon( QIcon( "./resources/40x40_device.png" ) );
    action_UseDeviceLater->setIcon( QIcon( "./resources/40x40_device_later.png" ) );

    action_DeviceClear->setIcon( QIcon( "./resources/40x40_device_clear.png" ) );

    action_DeviceStart->setIcon( QIcon( "./resources/40x40_device_start.png" ) );
    action_DeviceSkipStatus->setIcon( QIcon( "./resources/40x40_device_next.png" ) );
    action_DeviceReset->setIcon( QIcon( "./resources/40x40_stop.png" ) );

    action_DeviceSettings->setIcon( QIcon( "./resources/40x40_device_settings.png" ) );

    action_PatientCardSell->setIcon( QIcon("./resources/40x40_patientcard_sell.png") );

    action_ProductTypes->setIcon( QIcon("./resources/40x40_producttype.png") );
    action_ProductActionType->setIcon( QIcon("./resources/40x40_productactiontype.png") );
    action_Products->setIcon( QIcon("./resources/40x40_product.png") );

    action_PayCash->setIcon( QIcon( "./resources/40x40_paycash.png" ) );
    action_SellProduct->setIcon( QIcon( "./resources/40x40_productsell.png" ) );
    action_ShoppingCart->setIcon( QIcon( "./resources/40x40_shoppingcart.png" ) );
    action_Cassa->setIcon( QIcon( "./resources/40x40_cassa.png" ) );
    action_CassaActionStorno->setIcon( QIcon( "./resources/40x40_cassa_storno.png" ) );

    //--------------------------------------------------------------------------------
    // Menu items
    //--------------------------------------------------------------------------------
    action_About->setIcon( QIcon("./resources/40x40_information.png") );

    action_Patients->setIcon( QIcon("./resources/40x40_patient.png") );
    action_Guests->setIcon( QIcon("./resources/40x40_patient.png") );
    action_CardTypes->setIcon( QIcon( "./resources/40x40_patientcardtype.png" ) );
    action_Cards->setIcon( QIcon( "./resources/40x40_patientcards.png" ) );
    menuAdministrator->setIcon( QIcon("./resources/40x40_key.png") );
        action_Users->setIcon( QIcon("./resources/40x40_user.png") );
        action_Company->setIcon( QIcon("./resources/40x40_company.png") );
        action_HealthInsurance->setIcon( QIcon("./resources/40x40_health_insurance.png") );
        action_Discounts->setIcon( QIcon("./resources/40x40_discount.png") );
        action_RegionZipCity->setIcon( QIcon("./resources/40x40_address.png") );
        action_Paneltypes->setIcon( QIcon("./resources/40x40_panel.png") );
        action_PanelStatuses->setIcon( QIcon( "./resources/40x40_device_settings.png" ) );
        action_ValidateSerialKey->setIcon( QIcon( "./resources/40x40_key.png" ) );
    action_Preferences->setIcon( QIcon("./resources/40x40_settings.png") );

    menuProduct->setIcon( QIcon("./resources/40x40_product.png") );
    menuCassa->setIcon( QIcon( "./resources/40x40_cassa.png" ) );

//    menuPatient->setIcon( QIcon("./resources/40x40_patient.png") );
    menuPatientCard->setIcon( QIcon("./resources/40x40_patientcard.png") );
        action_PCSaveToDatabase->setIcon( QIcon( "./resources/40x40_patientcardadd.png" ) );
        action_PCActivate->setIcon( QIcon("./resources/40x40_patientcard_sell.png") );
    menuDevice->setIcon( QIcon( "./resources/40x40_device.png" ) );

    action_ReportViewer->setIcon( QIcon( "./resources/40x40_book_ledger.png" ) );
    action_Accounting->setIcon( QIcon( "./resources/40x40_book.png" ) );
    action_ReportPatients->setIcon( QIcon("./resources/40x40_patient.png") );
    action_ReportPatientcards->setIcon( QIcon( "./resources/40x40_patientcards.png" ) );
    action_PatientcardsObsolete->setIcon( QIcon( "./resources/40x40_patientcards.png" ) );
    action_ReportPatientcardUses->setIcon( QIcon( "./resources/40x40_device_withcard.png" ) );
    action_CassaHistory->setIcon( QIcon( "./resources/40x40_cassa.png" ) );

    action_EditLicenceInformation->setIcon( QIcon("./resources/40x40_key.png") );
    action_EmptyDemoDB->setIcon( QIcon("./resources/40x40_database_sync.png") );
    action_PaymentMethods->setIcon( QIcon("./resources/40x40_paymentmethod.png") );

    //--------------------------------------------------------------------------------
    //--------------------------------------------------------------------------------

    action_LogOut->setEnabled( false );
    action_Exit->setEnabled( false );

    action_PatientSelect->setEnabled( false );
    action_PatientEmpty->setEnabled( false );
    action_PatientEmpty->setVisible( false );
    action_PatientNew->setEnabled( false );
    action_EditActualPatient->setEnabled( false );
    action_UseDevice->setEnabled( false );
    action_UseDeviceLater->setEnabled( false );
    action_DeviceClear->setEnabled( false );
    action_DeviceStart->setEnabled( false );
    action_DeviceSkipStatus->setEnabled( false );
    action_DeviceReset->setEnabled( false );
    action_DeviceSettings->setEnabled( false );

    action_PatientCardSell->setEnabled( false );

    action_PayCash->setEnabled( false );
    action_Cassa->setEnabled( false );

    action_Accounting->setEnabled( false );
    action_Accounting->setVisible( false );
    action_ReportPatients->setEnabled( false );
    action_ReportPatients->setVisible( false );
    action_ReportPatientcards->setEnabled( false );
    action_ReportPatientcards->setVisible( false );
    action_PatientcardsObsolete->setEnabled( false );
    action_PatientcardsObsolete->setVisible( false );
    action_ReportPatientcardUses->setEnabled( false );
    action_ReportPatientcardUses->setVisible( false );
    action_CassaHistory->setEnabled( false );
    action_CassaHistory->setVisible( false );

    action_EmptyDemoDB->setEnabled( (g_poPrefs->getLicenceId()>1?true:false) );

    showElementsForComponents();

    m_dlgSecondaryWindow = new cDlgSecondaryWindow( this );

    if( g_poPrefs->isSecondaryWindowVisible() )
    {
        m_dlgSecondaryWindow->move( g_poPrefs->secondaryWindowPosition() );
        m_dlgSecondaryWindow->resize( g_poPrefs->secondaryWindowSize() );
        m_dlgSecondaryWindow->show();
        m_dlgSecondaryWindow->initPanels();
        this->setFocus();
    }

    m_lblStatusRight.setAlignment( Qt::AlignRight );
    m_lblStatusRight.setStyleSheet( "QLabel {font: bold; font-size:14px;}" );

    statusbar->addPermanentWidget( &m_lblStatusLeft, 3 );
    statusbar->addPermanentWidget( &m_lblStatusRight, 1 );
}
//====================================================================================
cWndMain::~cWndMain()
{
    cTracer obTrace( "cWndMain::~cWndMain" );

    delete m_dlgProgress;
    delete m_dlgSecondaryWindow;

    killTimer( m_nTimer );
}
//====================================================================================
void cWndMain::startMainTimer()
{
    mdiPanels->refreshDisplay();
    m_nTimer = startTimer( 250 );
}
//====================================================================================
void cWndMain::autoSynchronizeGlobalData()
//====================================================================================
{
    m_bGlobalDataRequested = true;
}
//====================================================================================
bool cWndMain::showLogIn()
{
    cTracer obTrace( "cWndMain::showLogIn" );

    cQTMySQLQueryModel *m_poModel = new cQTMySQLQueryModel( this );
    m_poModel->setQuery( "SELECT CONCAT(name,\" (\",realName,\")\") AS n FROM users WHERE active = 1 ORDER BY name" );
    cmbName->setModel( m_poModel );

    int inIdx = cmbName->findText( g_poPrefs->getLastUser() );
    if( inIdx != -1 ) cmbName->setCurrentIndex( inIdx );

    ledPassword->setText( "" );

    enableElementsByLogin( false );

    m_dlgProgress->hideProgress();

    ledPassword->setFocus();

    return true;
}
//====================================================================================
void cWndMain::on_pbLogin_clicked()
{
    try
    {
        string  stName = cmbName->currentText().toStdString();
        stName = stName.substr( 0, stName.find( '(' ) - 1 );
        g_obUser.load( QString::fromStdString(stName) );
        QByteArray  obPwdHash = QCryptographicHash::hash( ledPassword->text().toAscii(), QCryptographicHash::Sha1 );
        g_obUser.logIn( QString( obPwdHash.toHex() ) );

        g_poPrefs->setLastUser( cmbName->currentText(), true );

        enableElementsByLogin( true );

        g_obLogDBWriter.setAppUser( g_obUser.id() );
        g_obLogger(cSeverity::INFO) << "User " << g_obUser.name() << " (" << g_obUser.realName() << ") logged in" << EOM;

        if( g_obUser.password() == "da39a3ee5e6b4b0d3255bfef95601890afd80709" ) //password is an empty string
        {
            QMessageBox::warning( this, tr( "Password" ),
                                  tr( "Your password is empty. Please change it to a valid password." ) );

            cDlgUserEdit  obDlgEdit( this, &g_obUser );
            obDlgEdit.setWindowTitle( g_obUser.realName() );
            obDlgEdit.exec();
        }

        updateTitle();

        if( g_poPrefs->isComponentInternetInstalled() )
        {
            checkDemoLicenceKey();
        }
        loginUser();
    }
    catch( cSevException &e )
    {
        g_obLogger(cSeverity::INFO) << "User " << cmbName->currentText() << " failed to log in" << EOM;

        g_obUser.logOut();
        QMessageBox::critical( this, tr( "Login failed" ),
                               tr( "Incorrect User Name and/or Password. Please try again." ) );
    }
}
//====================================================================================
void cWndMain::enableElementsByLogin(bool p_bEnable)
{
    frmLogin->setVisible( !p_bEnable );
    frmLogin->setEnabled( !p_bEnable );
    mdiPanels->setEnabled( p_bEnable );
}
//====================================================================================
void cWndMain::showProgress()
{
    m_dlgProgress->showProgress();
}
//====================================================================================
void cWndMain::initPanels()
{
    mdiPanels->initPanels();
}
//====================================================================================
void cWndMain::checkDemoLicenceKey()
{
/*
    if( g_obLicenceManager.getType() == LicenceManager::VALID_SERVER_ERROR )
    {
        QMessageBox::warning( this, tr("Attention"),
                              tr("The application has valid serial key registered but was not able to validate it with the server.\n"
                                 "Please note that without validation the application will work only for the next %1 days\n\n"
                                 "Please also note you need live internet connection for the validation process.").arg(g_obLicenceManager.getDaysRemaining()) );
    }
    else if( g_obLicenceManager.getType() == LicenceManager::VALID_CODE_2_ERROR )
    {
        QMessageBox::warning( this, tr("Attention"),
                              tr("The application has valid serial key registered but failed to validate the installation with the server.\n"
                                 "Please call Service to validate your installation.\n\n"
                                 "Note that without validation the application will work only for the next %1 days").arg(g_obLicenceManager.getDaysRemaining()) );
    }
    else if( g_obLicenceManager.getType() == LicenceManager::VALID_EXPIRED ||
             g_obLicenceManager.getType() == LicenceManager::VALID_CODE_2_EXPIRED )
    {
        QMessageBox::warning( this, tr("Attention"),
                              tr("Your licence key has expired.\n"
                                 "The application has a serial key registered but failed to validate it with the server since the last %1 days.\n\n"
                                 "Please note you need live internet connection for the validation process.").arg(LicenceManager::EXPIRE_IN_DAYS) );
    }
    else if( g_obLicenceManager.getType()==LicenceManager::NOT_VALID )
    {
        QMessageBox::warning( this, tr("Attention"),
                              tr("Your licence key validation has failed.\n"
                                 "Please call Service") );
    } else if ( g_obLicenceManager.getType()==LicenceManager::DEMO )
    {
        if( QMessageBox::warning( this,
                                  tr("Attention"),
                                  tr("The application has no valid serial key registered.\n"
                                     "The application will only control the hardware with DEMO serial key for %1 days.\n\n"
                                     "Do you want to enter a valid serial key and register the application?\n"
                                     "Please note you need live internet connection for the registration process.").arg(LicenceManager::EXPIRE_IN_DAYS),
                                  QMessageBox::Yes | QMessageBox::No, QMessageBox::Yes ) == QMessageBox::Yes )
        {
            cDlgSerialReg   obDlgSerialReg( this );
            obDlgSerialReg.exec();
        }
    }
*/
}
//====================================================================================
void cWndMain::loginUser()
{
    cTracer obTrace( "cWndMain::loginUser" );

    // Felhasznalo ellenorzese
    if( g_obUser.isInGroup( cAccessGroup::ROOT ) || g_obUser.isInGroup( cAccessGroup::SYSTEM) )
    { // root, vagy rendszeradmin felhasznalo lepett be, NINCS penztar akcio
        g_obCassa.setDisabled();
        return;
    }

    // Felhasznalohoz tartozo, legutolso nem lezart kassza keresese
    if( g_obCassa.loadOpenCassa(g_obUser.id()) )
    {// Letezik nyitva hagyott, felhasznalohoz tartozo rekord

        g_obCassa.cassaContinue();
    }
    else
    {// Nincs korabban nyitva hagyott, felhasznalohoz tartozo rekord

        // Legutolso nem lezart kassza keresese
        if( g_obCassa.loadOpenCassa() )
        {// Van nyitva hagyott kassza rekord

            cCurrency cBalance( g_obCassa.cassaBalance() );
            if( QMessageBox::question( this, tr("Question"),
                                       tr( "The latest cassa record still not closed:\n\n"
                                           "Owner: %1\n"
                                           "Balance: %2\n\n"
                                           "Do you want to continue this cassa?\n\n"
                                           "Please note: if you click NO, new cassa record will be opened "
                                           "and this cassa forced to close with reseting it's balance.").arg( g_obCassa.cassaOwnerStr() ).arg( cBalance.currencyFullStringShort() ),
                                       QMessageBox::Yes, QMessageBox::No ) == QMessageBox::Yes )
            {
                g_obCassa.cassaContinue( g_obUser.id() );
            }
            else
            {
                g_obCassa.cassaDecreaseMoney( g_obCassa.cassaOwnerId(), g_obCassa.cassaBalance(), tr("Cassa left in open.") );
                g_obCassa.cassaClose();
                g_obCassa.createNew( g_obUser.id() );
            }
        }// Volt nyitva hagyott kassza rekord
        else
        {// Nem volt nyitva hagyott kassza rekord

            // Legutolso nem kiuritett kassza rekord betoltese
            if( g_obCassa.loadLatestCassaWithCash() )
            {
                // Akarja-e a felhasznalo folytatni a kasszat
                cCurrency cBalance( g_obCassa.cassaBalance() );
                if( QMessageBox::question( this, tr("Question"),
                                           tr( "The latest cassa record closed with balance:\n\n"
                                               "%1\n\n"
                                               "Do you want to continue this cassa?\n\n"
                                               "Please note: if you click NO, new cassa record will be opened "
                                               "and this cassa forced to close with reseting it's balance.").arg( cBalance.currencyFullStringShort() ),
                                           QMessageBox::Yes, QMessageBox::No ) == QMessageBox::Yes )
                {// Kassza folytatasa
                    g_obCassa.cassaReOpen();
                }
                else
                {// Uj kassza nyitasa
                    g_obCassa.cassaReOpen();
                    g_obCassa.cassaDecreaseMoney( g_obCassa.cassaBalance(), tr("Cash left in cassa.") );
                    g_obCassa.cassaClose();
                    g_obCassa.createNew( g_obUser.id() );
                }
            }
            else
            {// Nem volt nem kiuritett kassza

                // Felhasznalo utolso kasszajanak betoltese
                if( g_obCassa.loadLatestCassa( g_obUser.id() ) )
                {
                    // Akarja-e a felhasznalo folytatni a kasszat
                    if( QMessageBox::question( this, tr("Question"),
                                               tr( "The latest cassa record used:\n\n"
                                                   "from %1 to %2\n\n"
                                                   "Do you want to continue this cassa?").arg( g_obCassa.cassaOpenDate() ).arg( g_obCassa.cassaCloseDate() ),
                                                   QMessageBox::Yes, QMessageBox::No ) == QMessageBox::Yes )
                    {// Kassza folytatasa
                        g_obCassa.cassaReOpen();
                    }
                    else
                    {// Uj kassza nyitasa
                        g_obCassa.createNew( g_obUser.id() );
                    }
                }
                else
                {// Uj kassza nyitasa
                    g_obCassa.createNew( g_obUser.id() );
                }
            }
        }// Nem volt nyitva hagyott kassza rekord
    }// Nincs korabban nyitva hagyott, felhasznalohoz tartozo rekord
}
//====================================================================================
void cWndMain::logoutUser()
{
    if( g_obCassa.isCassaEnabled() )
    {
        if( !g_poPrefs->getCassaAutoClose() )
        {
            if( QMessageBox::question( this, tr("Question"),
                                       tr("Do you want to close your cassa?"),
                                       QMessageBox::Yes, QMessageBox::No ) == QMessageBox::Yes )
            {
                if( g_obCassa.cassaBalance() > 0 )
                {
                    cCurrency   cBalance( g_obCassa.cassaBalance() );

                    if( QMessageBox::question( this, tr("Question"),
                                               tr("There are some cash left in your cassa.\n"
                                                  "Current balance: %1\n\n"
                                                  "Do you want to close the cassa with automatic "
                                                  "cash withdawal?\n\n"
                                                  "Please note: if you click NO, the cassa will "
                                                  "be closed with the actual balance.").arg( cBalance.currencyFullStringShort() ),
                                               QMessageBox::Yes, QMessageBox::No ) == QMessageBox::Yes )
                    {
                        g_obCassa.cassaDecreaseMoney( g_obCassa.cassaBalance(), tr("Automatic cassa close.") );
                    }
                }
                g_obCassa.cassaClose();
            }
        }
        else
        {
            if( g_obCassa.cassaBalance() > 0 && !g_poPrefs->getCassaAutoWithdrawal() )
            {
                cCurrency   cBalance( g_obCassa.cassaBalance() );

                if( QMessageBox::question( this, tr("Question"),
                                           tr("There are some cash left in your cassa.\n"
                                              "Current balance: %1\n\n"
                                              "Do you want to close the cassa with automatic "
                                              "cash withdawal?\n\n"
                                              "Please note: if you click NO, the cassa will "
                                              "be closed with the actual balance.").arg( cBalance.currencyFullStringShort() ),
                                           QMessageBox::Yes, QMessageBox::No ) == QMessageBox::Yes )
                {
                    g_obCassa.cassaDecreaseMoney( g_obCassa.cassaBalance(), tr("Automatic cassa close.") );
                }
            }
            else if( g_obCassa.cassaBalance() > 0 && g_poPrefs->getCassaAutoWithdrawal() )
            {
                g_obCassa.cassaDecreaseMoney( g_obCassa.cassaBalance(), tr("Automatic cassa close.") );
            }
            g_obCassa.cassaClose();
        }
    }
}
//====================================================================================
void cWndMain::keyPressEvent ( QKeyEvent *p_poEvent )
{
    if( p_poEvent->key() == Qt::Key_Control )
    {
        m_bCtrlPressed = true;
        m_lblStatusLeft.setText( tr("Q -> Exit application | F -> pay device usage | S -> start device | N -> skip status | T -> device cleared | K -> open shopping kart") );
    }

    if( m_bCtrlPressed )
    {
        if( p_poEvent->key() == Qt::Key_Q )
        {
            m_bCtrlPressed = false;
            m_lblStatusLeft.setText( m_qsStatusText );
            close();
        }
        else if( p_poEvent->key() == Qt::Key_S && action_DeviceStart->isEnabled() )
        {
            m_bCtrlPressed = false;
            m_lblStatusLeft.setText( m_qsStatusText );
            on_action_DeviceStart_triggered();
        }
        else if( p_poEvent->key() == Qt::Key_T && action_DeviceClear->isEnabled() )
        {
            m_bCtrlPressed = false;
            m_lblStatusLeft.setText( m_qsStatusText );
            on_action_DeviceClear_triggered();
        }
        else if( p_poEvent->key() == Qt::Key_F && action_PayCash->isEnabled() )
        {
            m_bCtrlPressed = false;
            m_lblStatusLeft.setText( m_qsStatusText );
            on_action_PayCash_triggered();
        }
        else if( p_poEvent->key() == Qt::Key_K && action_ShoppingCart->isEnabled() )
        {
            m_bCtrlPressed = false;
            m_lblStatusLeft.setText( m_qsStatusText );
            on_action_ShoppingCart_triggered();
        }
        else if( p_poEvent->key() == Qt::Key_N && action_DeviceSkipStatus->isEnabled() )
        {
            m_bCtrlPressed = false;
            m_lblStatusLeft.setText( m_qsStatusText );
            on_action_DeviceSkipStatus_triggered();
        }
        else if( p_poEvent->key() == Qt::Key_F12 )
        {
            m_bCtrlPressed = false;
            m_lblStatusLeft.setText( m_qsStatusText );
            on_action_TestDlgStarted();
        }
    }
    else
    {
        if( p_poEvent->key() == Qt::Key_Enter || p_poEvent->key() == Qt::Key_Return )
        {
            switch( m_nEnterAction )
            {
                case cDBApplicationAction::APPACT_DEVICE_PAYCASH:
                    m_lblStatusLeft.setText( m_qsStatusText );
                    on_action_PayCash_triggered();
                    break;

                case cDBApplicationAction::APPACT_DEVICE_START:
                    m_lblStatusLeft.setText( m_qsStatusText );
                    on_action_DeviceStart_triggered();
                    break;

                case cDBApplicationAction::APPACT_DEVICE_SKIP:
                    m_lblStatusLeft.setText( m_qsStatusText );
                    on_action_DeviceSkipStatus_triggered();
                    break;

                case cDBApplicationAction::APPACT_DEVICE_CLEAN:
                    m_lblStatusLeft.setText( m_qsStatusText );
                    on_action_DeviceClear_triggered();
                    break;
            }
        }
        else if( ((p_poEvent->key() >= Qt::Key_0 && p_poEvent->key() <= Qt::Key_9) ||
                  (p_poEvent->key() >= Qt::Key_A && p_poEvent->key() <= Qt::Key_Z)) )
        {
            m_lblStatusLeft.setText( m_qsStatusText );

            cDlgInputStart  obDlgInputStart( this );

            obDlgInputStart.setInitialText( p_poEvent->text() );
            if( obDlgInputStart.exec() == QDialog::Accepted )
            {
                if( obDlgInputStart.m_bPat )
                {
                    processInputPatient( obDlgInputStart.getEditText().trimmed() );
                }
                else if( obDlgInputStart.m_bCard )
                {
                    processInputPatientCard( obDlgInputStart.getEditText() );
                }
                else if( obDlgInputStart.m_bProd )
                {
                    processInputProduct( obDlgInputStart.getEditText() );
                }
                else if( obDlgInputStart.m_bTime )
                {
                    processInputTimePeriod( obDlgInputStart.getEditText().toInt() );
                }
            }

            p_poEvent->ignore();
        }
        else if( p_poEvent->key() == Qt::Key_Escape && mdiPanels->isStatusCanBeReseted() )
        {
            m_lblStatusLeft.setText( m_qsStatusText );
            mdiPanels->clear();
        }
        else if( p_poEvent->key() == Qt::Key_Space )
        {
            on_action_UseDevice_triggered();
        }
    }

    QMainWindow::keyPressEvent( p_poEvent );
}
//====================================================================================
void cWndMain::keyReleaseEvent ( QKeyEvent *p_poEvent )
{
    if( p_poEvent->key() == Qt::Key_Control )
    {
        m_bCtrlPressed = false;
        m_lblStatusLeft.setText( m_qsStatusText );
    }

    QMainWindow::keyPressEvent( p_poEvent );
}
//====================================================================================
void cWndMain::showElementsForComponents()
{
//    cTracer obTrace( "cWndMain::showElementsForComponents" );

    if( g_poPrefs->isComponentKiwiSunInstalled() )
    {
        toolBarSchedule->setEnabled( false );
        toolBarSchedule->setVisible( false );

        action_Patients->setVisible( false );
        action_Company->setVisible( false );
        action_HealthInsurance->setVisible( false );
        action_ReportPatients->setVisible( false );
    }
}
//====================================================================================
void cWndMain::updateTitle()
{
    //cTracer obTrace( "cWndMain::updateTitle" );

    QString  qsTitle = tr( "Belenus " );
    qsTitle += g_poPrefs->getVersion();

    qsTitle += " - ";
    qsTitle += QString::fromStdString( g_poHardware->getCustomCaption() );

    if( QString::fromStdString( g_poHardware->getCustomCaption() ).compare( "DEMO" ) == 0 )
    {
        action_Hardwaretest->setEnabled( false );
    }

    if( g_obUser.isLoggedIn() )
    {
        qsTitle += " - ";
        qsTitle += g_obUser.realName();
        qsTitle += " [";
        qsTitle += cAccessGroup::toStr( g_obUser.group() );
        qsTitle += "]";
    }

    if( g_obGuest.id() > 0 )
    {
        qsTitle += tr(" <=> Current patient: [");
        qsTitle += g_obGuest.name();
        qsTitle += "]";
    }
    else
    {
        qsTitle += tr(" <=> NO PATIENT SELECTED");
    }

    action_Paneltypes->setEnabled( g_obUser.isInGroup( cAccessGroup::SYSTEM ) );
    action_PanelStatuses->setEnabled( g_obUser.isInGroup( cAccessGroup::ADMIN ) );

    setWindowTitle( qsTitle );
}
//====================================================================================
void cWndMain::updateStatusText( QString p_qsStatusText )
//====================================================================================
{
    if( m_bCtrlPressed )
        return;

    bool    bIsUserLoggedIn = g_obUser.isLoggedIn();

    m_qsStatusText = tr("SPACE -> Enter time/barcode ...");
    m_nEnterAction = 0;

    if( bIsUserLoggedIn && mdiPanels->isHasToPay() )
    {
        m_qsStatusText.append( tr(" | ENTER -> %1").arg( action_PayCash->toolTip() ) );
        m_nEnterAction = cDBApplicationAction::APPACT_DEVICE_PAYCASH;
    }
    else if( bIsUserLoggedIn && !mdiPanels->isPanelWorking(mdiPanels->activePanel()) && mdiPanels->mainProcessTime() > 0 )
    {
        m_qsStatusText.append( tr(" | ENTER -> %1").arg( action_DeviceStart->toolTip() ) );
        m_nEnterAction = cDBApplicationAction::APPACT_DEVICE_START;
    }
    else if( bIsUserLoggedIn && mdiPanels->isNeedToBeCleaned() )
    {
        m_qsStatusText.append( tr(" | ENTER -> %1").arg( action_DeviceClear->toolTip() ) );
        m_nEnterAction = cDBApplicationAction::APPACT_DEVICE_CLEAN;
    }
    else if( bIsUserLoggedIn && mdiPanels->isStatusCanBeSkipped( mdiPanels->activePanel()) )
    {
        m_qsStatusText.append( tr(" | ENTER -> %1").arg( action_DeviceSkipStatus->toolTip() ) );
        m_nEnterAction = cDBApplicationAction::APPACT_DEVICE_SKIP;
    }

    m_lblStatusLeft.setText( m_qsStatusText );
}
//====================================================================================
void cWndMain::updateToolbar()
{
    bool    bIsUserLoggedIn = g_obUser.isLoggedIn();

    action_LogOut->setEnabled( bIsUserLoggedIn );
    action_Exit->setEnabled( !mdiPanels->isPanelWorking() );

    menu_Edit->setEnabled( bIsUserLoggedIn );
        action_Guests->setEnabled( bIsUserLoggedIn );
        action_CardTypes->setEnabled( bIsUserLoggedIn );
        action_Cards->setEnabled( bIsUserLoggedIn );
        menuAdministrator->setEnabled( bIsUserLoggedIn );
            action_Users->setEnabled( bIsUserLoggedIn );
            action_Company->setEnabled( bIsUserLoggedIn );
            action_HealthInsurance->setEnabled( bIsUserLoggedIn );
            action_Discounts->setEnabled( bIsUserLoggedIn );
            action_RegionZipCity->setEnabled( bIsUserLoggedIn );
            action_Paneltypes->setEnabled( bIsUserLoggedIn );
            action_PanelStatuses->setEnabled( bIsUserLoggedIn );
            action_ProductTypes->setEnabled( bIsUserLoggedIn );
            action_ProductActionType->setEnabled( bIsUserLoggedIn );
            action_Products->setEnabled( bIsUserLoggedIn );
            action_PaymentMethods->setEnabled( bIsUserLoggedIn );
            action_ValidateSerialKey->setEnabled( bIsUserLoggedIn );
            action_EditLicenceInformation->setEnabled( bIsUserLoggedIn );
            action_EmptyDemoDB->setEnabled( bIsUserLoggedIn );
        action_Preferences->setEnabled( bIsUserLoggedIn );

    menu_Action->setEnabled( bIsUserLoggedIn );
        menuDevice->setEnabled( bIsUserLoggedIn );
            action_UseDevice->setEnabled( bIsUserLoggedIn && (mdiPanels->isCanBeStartedByCard() || mdiPanels->isCanBeStartedByTime()) );
            action_UseDeviceLater->setEnabled( bIsUserLoggedIn );
            action_DeviceClear->setEnabled( bIsUserLoggedIn && mdiPanels->isNeedToBeCleaned() );
            action_DeviceStart->setEnabled( bIsUserLoggedIn && !mdiPanels->isPanelWorking(mdiPanels->activePanel()) && mdiPanels->mainProcessTime() > 0 );
            action_DeviceSkipStatus->setEnabled( bIsUserLoggedIn && mdiPanels->isStatusCanBeSkipped( mdiPanels->activePanel()) );
            action_DeviceReset->setEnabled( bIsUserLoggedIn && mdiPanels->isMainProcess() );
        menuPatientCard->setEnabled( bIsUserLoggedIn );
            action_PatientCardSell->setEnabled( bIsUserLoggedIn );
            action_PCSaveToDatabase->setEnabled( bIsUserLoggedIn );
        menuProduct->setEnabled( bIsUserLoggedIn );
            action_SellProduct->setEnabled( bIsUserLoggedIn );
        menuCassa->setEnabled( bIsUserLoggedIn );
            action_CassaActionStorno->setEnabled( bIsUserLoggedIn );

    menu_Reports->setEnabled( bIsUserLoggedIn );

    menu_View->setEnabled( bIsUserLoggedIn );
        action_Cassa->setEnabled( bIsUserLoggedIn && g_obCassa.isCassaEnabled() );
        action_Logs->setEnabled( bIsUserLoggedIn );
        action_Hardwaretest->setEnabled( bIsUserLoggedIn );

    toolBarPatient->setEnabled( bIsUserLoggedIn );
        action_PatientNew->setEnabled( bIsUserLoggedIn );
        action_PatientSelect->setEnabled( bIsUserLoggedIn && !(g_obGuest.id()>0) );
        action_PatientEmpty->setEnabled( bIsUserLoggedIn && g_obGuest.id()>0 );
        action_EditActualPatient->setEnabled( bIsUserLoggedIn && g_obGuest.id()>0 );

    toolBarDeviceUse->setEnabled( bIsUserLoggedIn );
        action_DeviceSettings->setEnabled( bIsUserLoggedIn && !mdiPanels->isPanelWorking(mdiPanels->activePanel()) );

    toolBarCassa->setEnabled( bIsUserLoggedIn );
        action_PayCash->setEnabled( bIsUserLoggedIn && mdiPanels->isHasToPay() );

    action_PatientSelect->setVisible( !(g_obGuest.id()>0) );
    action_PatientEmpty->setVisible( g_obGuest.id()>0 );

    showElementsForComponents();
}
//====================================================================================
void cWndMain::timerEvent(QTimerEvent *)
{
    updateStatusText();
    updateToolbar();

    if( m_bSerialRegistration )
    {
        if( g_poPrefs->getLicenceId() > 1 )
        {
            m_bSerialRegistration = false;

//            g_obCassa.cassaClose();
//            g_obCassa.createNew( g_obUser.id() );

            if( QMessageBox::question( this, tr("Question"),
                                       tr("Application licence key successfully registered.\n"
                                          "The application users currently attached to DEMO licence key.\n\n"
                                          "Do you want to update application users and attach them to the newly registered licence key?"),
                                       QMessageBox::Yes | QMessageBox::No, QMessageBox::No ) == QMessageBox::Yes )
            {
                g_poDB->executeQTQuery( QString("UPDATE users SET licenceId=%1 WHERE licenceId=1").arg(g_poPrefs->getLicenceId()) );
            }
            else
            {
                g_poDB->executeQTQuery( QString("UPDATE users SET licenceId=%1 WHERE (userId=1 OR userId=2) AND licenceId=1").arg(g_poPrefs->getLicenceId()) );
            }

            if( QMessageBox::question( this, tr("Question"),
                                       tr("Do you want to set the additional information of the studio now?"),
                                       QMessageBox::Yes | QMessageBox::No, QMessageBox::No ) == QMessageBox::Yes )
            {
                dlgLicenceEdit  obDlgLicenceEdit( this );

                obDlgLicenceEdit.exec();
            }
        }
        else
        {
            if( m_inRegistrationTimeout > 20 )
            {
                m_bSerialRegistration = false;
                m_inRegistrationTimeout = 0;

                QMessageBox::warning( this, tr("Warning"),
                                      tr("Registration of the licence key has been failed.\n\n"
                                         "Please check your internet connection and "
                                         "try to restart the application.\n"
                                         "Please also check whether the defined licence key is valid "
                                         "and not used by somebody else. For this information please "
                                         "contact your franchise distributor.") );
            }
            else
            {
                m_inRegistrationTimeout++;
            }
        }
    }

    if( m_uiPatientId != g_obGuest.id() )
    {
        updateTitle();

        m_uiPatientId = g_obGuest.id();
    }

    m_lblStatusRight.setText( QDateTime::currentDateTime().toString( "yyyy-MM-dd hh:mm:ss  " ) );
}
//====================================================================================
void cWndMain::closeEvent( QCloseEvent *p_poEvent )
{
    bool    bIsShutdown = true;

    if( mdiPanels->isPanelWorking() )
    {
        QMessageBox::warning( this, tr("Attention"),
                              tr("At least one Panel is still working.\n"
                                 "Please stop them before closing the application.") );
        p_poEvent->ignore();
        bIsShutdown = false;
    }
    else
    {
        if( QMessageBox::question( this, tr("Question"),
                                   tr("Are you sure you want to close the application?"),
                                   QMessageBox::Yes | QMessageBox::No, QMessageBox::No ) == QMessageBox::Yes )
        {
            logoutUser();
/*
            if( g_obDBMirror.isAvailable() )
            {
                if( g_poPrefs->getDBAutoArchive() ||
                    (g_obDBMirror.checkIsSynchronizationNeeded() &&
                     QMessageBox::question( this, tr("Question"),
                                            tr("Database synchronization needed.\n"
                                               "Do you want to synchronize database with server?"),
                                            QMessageBox::Yes | QMessageBox::No, QMessageBox::No ) == QMessageBox::Yes ) )
                {
                    hide();

                    cDlgSynchronization     obDlgSynchronization( this );

                    obDlgSynchronization.autoSynchronization();
                    obDlgSynchronization.exec();
                }
            }
*/
            p_poEvent->accept();
        }
        else
        {
            p_poEvent->ignore();
            bIsShutdown = false;
        }
    }
    if( !bIsShutdown && g_obUser.id() < 1 )
    {
        on_action_LogOut_triggered();
    }
}
//====================================================================================
void cWndMain::on_action_Preferences_triggered()
{
    m_dlgProgress->showProgress();

    cDlgPreferences  obDlgPrefs( this );

    m_dlgProgress->hideProgress();

    if( obDlgPrefs.exec() == QDialog::Accepted )
    {
        retranslateUi( this );
        mdiPanels->hide();
        mdiPanels->placeSubWindows();
        mdiPanels->setBackground( QBrush( QColor( g_poPrefs->getMainBackground() ) ) );
        mdiPanels->show();
        mdiPanels->refreshDisplay();

        m_dlgSecondaryWindow->refreshBackground();

        if( g_poPrefs->isSecondaryWindowVisible() && !m_dlgSecondaryWindow->isVisible() )
        {
            m_dlgSecondaryWindow->move( g_poPrefs->secondaryWindowPosition() );
            m_dlgSecondaryWindow->resize( g_poPrefs->secondaryWindowSize() );
            m_dlgSecondaryWindow->show();
            this->setFocus();
        }
        else if( !g_poPrefs->isSecondaryWindowVisible() )
        {
            g_poPrefs->setSecondaryWindowPosition( QPoint( m_dlgSecondaryWindow->x(), m_dlgSecondaryWindow->y() ), true );
            g_poPrefs->setSecondaryWindowSize( QSize( m_dlgSecondaryWindow->width(), m_dlgSecondaryWindow->height() ), true );
            m_dlgSecondaryWindow->hide();
        }
    }
}
//====================================================================================
void cWndMain::on_action_Users_triggered()
{
    m_dlgProgress->showProgress();

    cDlgUsers  obDlgUsers( this );

    m_dlgProgress->hideProgress();

    obDlgUsers.exec();

    updateTitle();  //needed in case the login or real name of current user changed
}
//====================================================================================
void cWndMain::on_action_Logs_triggered()
{
    cTracer obTrace( "cWndMain::on_action_Logs_triggered" );

    cDlgLogs  obDlgLogs( this );

    obDlgLogs.exec();
}
//====================================================================================
void cWndMain::on_action_Hardwaretest_triggered()
{
    cTracer obTrace( "cWndMain::on_action_Hardwaretest_triggered" );

    if( g_obUser.isInGroup( cAccessGroup::SYSTEM ) )
    {
        cDlgHardwareTest  obDlgHardwareTest( this );

        obDlgHardwareTest.exec();
    }
    else
    {
        QMessageBox::warning( this, tr( "Information" ),
                              tr( "This area is restricted for system administrators only!" ) );
    }
}
//====================================================================================
void cWndMain::on_action_LogOut_triggered()
{
    cTracer obTrace( "cWndMain::on_action_Log_Out_triggered" );

    logoutUser();

    g_obLogger(cSeverity::INFO) << "User " << g_obUser.name() << " (" << g_obUser.realName() << ") logged out" << EOM;

    g_obUser.logOut();
    g_obLogDBWriter.setAppUser( 0 );
    updateTitle();

    if( !showLogIn() ) close();
}
//====================================================================================
void cWndMain::on_action_Paneltypes_triggered()
{
    m_dlgProgress->showProgress();

    cDlgPanelTypes  obDlgPanelTypes( this );

    m_dlgProgress->hideProgress();

    obDlgPanelTypes.exec();
}
//====================================================================================
void cWndMain::on_action_Guests_triggered()
{
    m_dlgProgress->showProgress();

    cDlgGuest  obDlgGuest( this );

    m_dlgProgress->hideProgress();

    obDlgGuest.exec();
}
//====================================================================================
void cWndMain::on_action_PatientNew_triggered()
{
    m_dlgProgress->showProgress();

    cDBGuest *poGuest = new cDBGuest;
    poGuest->createNew();

    cDlgGuestEdit  obDlgEdit( this, poGuest );
    obDlgEdit.setWindowTitle( tr( "New Patient" ) );

    m_dlgProgress->hideProgress();

    obDlgEdit.exec();

    if( poGuest->id() > 0 )
    {
        if( QMessageBox::question( this, tr("Question"),
                                   tr("Do you want to select the created patient as actual?"),
                                   QMessageBox::Yes | QMessageBox::No, QMessageBox::No ) == QMessageBox::Yes )
        {
            g_obGuest.load( poGuest->id() );
        }
    }

    delete poGuest;
}
//====================================================================================
void cWndMain::on_action_DeviceClear_triggered()
{
    mdiPanels->clean();
}
//====================================================================================
void cWndMain::on_action_DeviceStart_triggered()
{
    if( !action_DeviceStart->isEnabled() )
        return;

    if( mdiPanels->isHasToPay() )
    {
        QMessageBox::warning( this, tr("Warning"),
                              tr("The device usage has to be payed.\n"
                                 "Please process the payment first.") );
        return;
    }

    mdiPanels->start();

    on_action_PatientEmpty_triggered();
}
//====================================================================================
void cWndMain::on_action_DeviceReset_triggered()
{
    mdiPanels->reset();
}
//====================================================================================
void cWndMain::on_action_PatientSelect_triggered()
{
    m_dlgProgress->showProgress();

    cDlgPatientSelect  obDlgPatientSelect( this );

    m_dlgProgress->hideProgress();

    obDlgPatientSelect.exec();
    updateTitle();
}
//====================================================================================
void cWndMain::on_action_PatientEmpty_triggered()
{
    cTracer obTrace( "cWndMain::on_action_PatientEmpty_triggered" );

    g_obGuest.createNew();

    updateTitle();
}
//====================================================================================
void cWndMain::on_action_PanelStatuses_triggered()
{
    m_dlgProgress->showProgress();

    cDlgPanelStatuses   obDlgPanelStatuses( this );

    m_dlgProgress->hideProgress();

    obDlgPanelStatuses.exec();

    if( obDlgPanelStatuses.isStatusChanged() )
    {
        QMessageBox::information( this, tr( "Information" ),
                                  tr( "Some of the changes you made will only be applied after the application is restarted." ) );
    }

}
//====================================================================================
void cWndMain::on_action_UseDevice_triggered()
{
    cDlgPanelUse obDlgPanelUse( this, mdiPanels->activePanelId() );

    obDlgPanelUse.enableCardUsage( mdiPanels->isCanBeStartedByCard() );
    obDlgPanelUse.enableCashUsage( mdiPanels->isCanBeStartedByTime() );

    if( m_inPanelStartMinute > 0 )
    obDlgPanelUse.setPanelUseTime( mdiPanels->mainProcessTime() );

    if( obDlgPanelUse.exec() == QDialog::Accepted )
    {
        if( obDlgPanelUse.panelUsePatientCardId() > 0 && obDlgPanelUse.panelUseSecondsCard() > 0 )
        {
            mdiPanels->setMainProcessTime( obDlgPanelUse.panelUsePatientCardId(), obDlgPanelUse.panelUnitIds(), obDlgPanelUse.panelUseSecondsCard() );

            int nCount = obDlgPanelUse.countPatientCardUnitsLeft();
            mdiPanels->setTextInformation( tr( "%1 units left on the selected card" ).arg(nCount) );
        }
        if( obDlgPanelUse.panelUseSecondsCash() > 0 )
        {
            mdiPanels->setMainProcessTime( obDlgPanelUse.panelUseSecondsCash(), obDlgPanelUse.panelUsePrice() );
        }
    }
}
//====================================================================================
void cWndMain::on_action_UseDeviceLater_triggered()
{
/*    QMessageBox msgBox;
    msgBox.setText("The document has been modified.");
    msgBox.setDetailedText("Do you want to save your changes?");
    msgBox.setStandardButtons(QMessageBox::Save | QMessageBox::Discard | QMessageBox::Cancel);
    msgBox.setDefaultButton(QMessageBox::Save);
    int ret = msgBox.exec();

    QMessageBox customQuestion( QMessageBox::Question, tr("Warning"), tr("Custom text"), QMessageBox::Yes | QMessageBox::No, this );

    customQuestion.setButtonText( QMessageBox::Yes, tr("custom text 1") );
    customQuestion.setButtonText( QMessageBox::No, tr("custom text 2") );

    customQuestion.exec();*/
}
//====================================================================================
void cWndMain::on_action_Cards_triggered()
{
    m_dlgProgress->showProgress();

    cDlgPatientCard obDlgPatientCard( this );

    connect( &obDlgPatientCard, SIGNAL(signalReplacePatientCard(QString)), this, SLOT(slotReplacePatientCard(QString)) );
    connect( &obDlgPatientCard, SIGNAL(signalAssignPartnerCard(QString)), this, SLOT(slotAssignPartnerCard(QString)) );

    m_dlgProgress->hideProgress();

    obDlgPatientCard.exec();
}
//====================================================================================
void cWndMain::on_action_CardTypes_triggered()
{
    m_dlgProgress->showProgress();

    cDlgPatientCardType obDlgPatientCardType( this );

    m_dlgProgress->hideProgress();

    obDlgPatientCardType.exec();
}
//====================================================================================
void cWndMain::on_action_ProductTypes_triggered()
{
    m_dlgProgress->showProgress();

    cDlgProductType obDlgProductType( this );

    m_dlgProgress->hideProgress();

    obDlgProductType.exec();
}
//====================================================================================
void cWndMain::on_action_ProductActionType_triggered()
{
    m_dlgProgress->showProgress();

    cDlgProductActionType obDlgProductActionType( this );

    m_dlgProgress->hideProgress();

    obDlgProductActionType.exec();
}
//====================================================================================
void cWndMain::on_action_Products_triggered()
{
    m_dlgProgress->showProgress();

    cDlgProduct obDlgProduct( this );

    m_dlgProgress->hideProgress();

    obDlgProduct.exec();
}
//====================================================================================
void cWndMain::on_action_SellProduct_triggered()
{
    on_action_SellProduct_triggered( "" );
}
//====================================================================================
void cWndMain::on_action_SellProduct_triggered( QString p_qsBarcode )
{
    m_dlgProgress->showProgress();

    cDlgProductSell obDlgProductSell( this, p_qsBarcode );

    connect( &obDlgProductSell, SIGNAL(signalPaymentProcessed(cDBShoppingCart)), this, SLOT(processProductSellPayment(cDBShoppingCart)) );

    m_dlgProgress->hideProgress();

    obDlgProductSell.exec();
}
//====================================================================================
void cWndMain::on_action_ShoppingCart_triggered()
{
    slotOpenShoppingCart( 0 );
}
//====================================================================================
void cWndMain::slotOpenShoppingCart( unsigned int p_uiPanelId )
{
    m_dlgProgress->showProgress();

    cDlgShoppingCart    obDlgShoppingCart( this );

    connect( &obDlgShoppingCart, SIGNAL(signalPaymentProcessed(unsigned int,unsigned int,int)), this, SLOT(processDeviceUsePayment(unsigned int,unsigned int,int)) );

    if( p_uiPanelId > 0 )
        obDlgShoppingCart.setPanelFilter( p_uiPanelId );

    m_dlgProgress->hideProgress();

    obDlgShoppingCart.exec();
}
//====================================================================================
void cWndMain::slotOpenScheduleTable( unsigned int p_uiPanelId )
{

}
//====================================================================================
void cWndMain::on_action_CassaActionStorno_triggered()
{
    m_dlgProgress->showProgress();

    cDlgStorno  obDlgStorno( this );

    m_dlgProgress->hideProgress();

    obDlgStorno.exec();
}
//====================================================================================
void cWndMain::on_action_PCSaveToDatabase_triggered()
{
    m_dlgProgress->showProgress();

    cDlgPatientCardAdd  obDlgPatientCardAdd( this );

    m_dlgProgress->hideProgress();

    obDlgPatientCardAdd.exec();
}
//====================================================================================
void cWndMain::on_action_Cassa_triggered()
{
    m_dlgProgress->showProgress();

    cDlgCassaEdit   obDlgCassaEdit( this );

    m_dlgProgress->hideProgress();

    obDlgCassaEdit.exec();
}
//====================================================================================
void cWndMain::on_action_Accounting_triggered()
{
    m_dlgProgress->showProgress();

    cDlgRepLedgerMain  obDlgLedgerMain( this );

    m_dlgProgress->hideProgress();

    obDlgLedgerMain.exec();
}
//====================================================================================
void cWndMain::on_action_DeviceSkipStatus_triggered()
{
    if( QMessageBox::question( this, tr("Question"),
                               tr("Do you want to jump to the next status of the device?"),
                               QMessageBox::Yes,QMessageBox::No ) == QMessageBox::Yes )
    {
        mdiPanels->next();
    }
}
//====================================================================================
void cWndMain::on_action_ValidateSerialKey_triggered()
{
    if( !g_obUser.isInGroup( cAccessGroup::ADMIN ) )
    {
        QMessageBox::warning( this, tr("Warning"),
                              tr("You are not authorized to activate or modify\n"
                                 "the licence key or the application's validity.") );
    }
    else
    {
        cDlgSerialReg   obDlgSerialReg( this );

        if( obDlgSerialReg.exec() == QDialog::Accepted )
        {
            m_inRegistrationTimeout = 0;
            m_bSerialRegistration = true;
        }
    }
}
//====================================================================================
void cWndMain::on_action_PatientCardSell_triggered()
{
    cDlgInputStart  obDlgInputStart( this );

    obDlgInputStart.m_bCard = true;
    obDlgInputStart.init();
    if( obDlgInputStart.exec() == QDialog::Accepted )
    {
        cDBPatientCard  obDBPatientCard;
        try
        {
            obDBPatientCard.load( obDlgInputStart.getEditText() );

            if( obDBPatientCard.pincode().compare("LOST") == 0 )
            {
                QMessageBox::warning( this, tr("Attention"),
                                      tr("This patientcard has been lost and replaced\nand can not be used or sold again.") );
                return;
            }
        }
        catch( cSevException &e )
        {
            if( QString(e.what()).compare("Patientcard barcode not found") != 0 )
            {
                g_obLogger(e.severity()) << e.what() << EOM;
            }
            else
            {
                if( QMessageBox::question( this, tr("Question"),
                                           tr("This barcode has not found in the database.\n"
                                              "Do you want to register it for a new patientcard?"),
                                           QMessageBox::Yes,QMessageBox::No ) == QMessageBox::Yes )
                {
                    obDBPatientCard.createNew();
                    obDBPatientCard.setLicenceId( g_poPrefs->getLicenceId() );
                    obDBPatientCard.setBarcode( obDlgInputStart.getEditText() );
                    obDBPatientCard.save();
                }
            }
        }
        if( obDBPatientCard.active() && obDBPatientCard.patientId() > 0 )
        {
            if( obDBPatientCard.units() < 1 || obDBPatientCard.timeLeft() < 1 )
            {
                QString     qsTemp = "";

                if( obDBPatientCard.timeLeft() < 1 )
                {
                    qsTemp = tr("\nDue to there is no time left, the patientcard will be reseted and deactivated.");
                }
                if( QMessageBox::question( this, tr("Question"),
                                           tr("This patientcard has the following settings:\n\n"
                                              "Available units: %1\n"
                                              "Available time: %2 (hh:mm:ss)\n\n"
                                              "Do you want to refill the patientcard now?%3").arg(obDBPatientCard.units()).arg(obDBPatientCard.timeLeftStr()).arg(qsTemp),
                                           QMessageBox::Yes,QMessageBox::No ) == QMessageBox::No )
                {
                    return;
                }
                else
                {
                    if( obDBPatientCard.timeLeft() < 1 )
                    {
                        obDBPatientCard.setActive( false );
                        obDBPatientCard.setPatientCardTypeId( 0 );
                    }
                    cDlgPatientCardRefill obDlgPatientCardRefill( this, &obDBPatientCard );
                    obDlgPatientCardRefill.exec();
                }
            }
            else
            {
                if( QMessageBox::question( this, tr("Question"),
                                           tr("This patientcard still can be used.\n"
                                              "Do you want to refill anyway?"),
                                           QMessageBox::Yes,QMessageBox::No ) == QMessageBox::Yes )
                {
                    obDBPatientCard.setPatientCardTypeId( 0 );
                    cDlgPatientCardRefill obDlgPatientCardRefill( this, &obDBPatientCard );
                    obDlgPatientCardRefill.exec();
                }
            }
        }
        else
        {
            cDlgPatientCardSell obDlgPatientCardSell( this, &obDBPatientCard );
            obDlgPatientCardSell.setPatientCardOwner( g_obGuest.id() );
            obDlgPatientCardSell.exec();
        }
    }
}
//====================================================================================
void cWndMain::processInputPatient( QString p_stPatientName )
{
// 'SOLARIUM GUEST'
/*
    cDBPatient      obDBPatient;
    unsigned int    uiPatientCount = obDBPatient.getPatientCount(p_stPatientName.trimmed());

    if( uiPatientCount > 1 )
    {
        cDlgPatientSelect  obDlgPatientSelect( this );
        obDlgPatientSelect.setSearchPatientName( p_stPatientName.trimmed() );
        obDlgPatientSelect.exec();
    }
    else if( uiPatientCount == 1 )
    {
        g_obGuest.load( obDBPatient.id() );
    }
    else
    {
        if( QMessageBox::question( this, tr("Question"),
                                   tr("There is no patient in the database with name like\n\n"
                                      "\'%1\'\n\n"
                                      "Do you want to create a new patient record with this name?").arg(p_stPatientName.trimmed()),
                                   QMessageBox::Yes | QMessageBox::No, QMessageBox::No ) == QMessageBox::Yes )
        {
            cDBPatient  obDBPatient;

            obDBPatient.createNew();
            obDBPatient.setName( p_stPatientName );

            cDlgPatientEdit  obDlgEdit( this, &obDBPatient );
            obDlgEdit.setWindowTitle( obDBPatient.name() );
            obDlgEdit.exec();
        }
    }
*/
}
//====================================================================================
void cWndMain::processInputPatientCard( QString p_stBarcode )
{
    cDBPatientCard  obDBPatientCard;

    try
    {
        obDBPatientCard.load( p_stBarcode );

        if( obDBPatientCard.patientCardTypeId() == 1 && !g_obUser.isInGroup(cAccessGroup::SYSTEM) )
        {
            QMessageBox::warning( this, tr("Attention"),
                                  tr("You are not allowed to use system administrator card.\nPlease log in as a system administrator if you want to use this card.") );
            return;
        }

        if( obDBPatientCard.pincode().compare("LOST") == 0 )
        {
            QMessageBox::warning( this, tr("Attention"),
                                  tr("This patientcard has been lost and replaced\nand can not be used or sold again.") );
            return;
        }

        if( !mdiPanels->isCanBeStartedByCard() )
        {
            QMessageBox::warning( this, tr("Attention"),
                                  tr("This device already prepared with a patientcard.\n"
                                     "To start the device with other conditions, please\n"
                                     "reset the device first with pushing the ESC button.") );
            return;
        }

        if( obDBPatientCard.active() )
        {
            if( obDBPatientCard.units() < 1 || obDBPatientCard.timeLeft() < 1 )
            {
                QString     qsTemp = "";

                if( obDBPatientCard.timeLeft() < 1 )
                {
                    qsTemp = tr("\n\nDue to there is no time left, the patientcard will be reseted and deactivated.");
                }
                if( QMessageBox::question( this, tr("Question"),
                                           tr("This patientcard can not be used with these settings:\n\n"
                                              "Available units: %1\n"
                                              "Available time: %2 (hh:mm:ss)\n\n"
                                              "Do you want to refill the patientcard now?%3").arg(obDBPatientCard.units()).arg(obDBPatientCard.timeLeftStr()).arg(qsTemp),
                                           QMessageBox::Yes,QMessageBox::No ) == QMessageBox::No )
                {
                    return;
                }
                else
                {
                    if( obDBPatientCard.timeLeft() < 1 )
                    {
                        obDBPatientCard.setPatientCardTypeId( 0 );
                        obDBPatientCard.setParentId( 0 );
                        obDBPatientCard.setPatientId( 0 );
                        obDBPatientCard.setUnits( 0 );
                        obDBPatientCard.setAmount( 0 );
                        obDBPatientCard.setTimeLeft( 0 );
                        obDBPatientCard.setValidDateFrom( "2000-01-01" );
                        obDBPatientCard.setValidDateTo( "2000-01-01" );
                        obDBPatientCard.setActive( false );

                        cDlgPatientCardSell obDlgPatientCardSell( this, &obDBPatientCard );
                        obDlgPatientCardSell.setPatientCardOwner( g_obGuest.id() );

                        if( obDlgPatientCardSell.exec() != QDialog::Accepted )
                        {
                            return;
                        }
                    }
                    else
                    {
                        cDlgPatientCardRefill obDlgPatientCardRefill( this, &obDBPatientCard );

                        if( obDlgPatientCardRefill.exec() != QDialog::Accepted )
                        {
                            return;
                        }
                    }
                }
            }

            QString qsValid;
            if( !obDBPatientCard.isPatientCardCanBeUsed( &qsValid ) )
            {
                QMessageBox::warning( this, tr("Warning"),
                                      tr("This patientcard currently can not be used.\n"
                                         "Please check it's validity time period.\n\n%1").arg(qsValid) );
                return;
            }

            if( g_obGuest.id() == 0 && obDBPatientCard.patientId() > 0 )
            {
                cDBGuest  obDBGuest;

                obDBGuest.load( obDBPatientCard.patientId() );
                if( QMessageBox::question( this, tr("Question"),
                                           tr("This patientcard has been assigned to the following patient.\n\n"
                                              "%1\n\n"
                                              "Do you want to select this patient as actual?").arg( obDBGuest.name() ),
                                           QMessageBox::Yes,QMessageBox::No ) == QMessageBox::Yes )
                {
                    g_obGuest.load( obDBPatientCard.patientId() );
                }
            }
            else if( obDBPatientCard.patientId() != g_obGuest.id() && g_obGuest.id() > 0 && obDBPatientCard.patientId() > 0 )
            {
                if( QMessageBox::question( this, tr("Question"),
                                           tr("This patientcard has been assigned to a different patient.\n"
                                              "Are you sure you want to use this patientcard?"),
                                           QMessageBox::Yes,QMessageBox::No ) == QMessageBox::No )
                {
                    return;
                }
            }
            else if( g_obGuest.id() > 0 && obDBPatientCard.patientId() == 0 )
            {
                if( QMessageBox::question( this, tr("Question"),
                                           tr("There is no patient assigned to this patientcard.\n"
                                              "Do you want to assign this patientcard to the actual patient?"),
                                           QMessageBox::Yes,QMessageBox::No ) == QMessageBox::Yes )
                {
                    obDBPatientCard.setPatientId( g_obGuest.id() );
                    obDBPatientCard.save();
                }
            }

            cDlgPanelUse obDlgPanelUse( this, mdiPanels->activePanelId() );

            obDlgPanelUse.enableCardUsage( mdiPanels->isCanBeStartedByCard() );
            obDlgPanelUse.enableCashUsage( mdiPanels->isCanBeStartedByTime() );
            obDlgPanelUse.setPanelUseTime( mdiPanels->mainProcessTime() );
            obDlgPanelUse.setPanelUsePatientCard( obDBPatientCard.id() );

            if( obDlgPanelUse.exec() == QDialog::Accepted )
            {
                mdiPanels->setMainProcessTime( obDBPatientCard.id(), obDlgPanelUse.panelUnitIds(), obDlgPanelUse.panelUseSecondsCard()+obDlgPanelUse.panelUseSecondsCash() );
                int nCount = obDBPatientCard.units()-obDlgPanelUse.panelUnitIds().count();
                mdiPanels->setTextInformation( tr( "%1 units left on the selected card" ).arg(nCount) );
            }
        }
        else
        {
            if( QMessageBox::question( this, tr("Question"),
                                       tr("This barcode has not been activated yet.\n"
                                          "Do you want to activate and sell it now?"),
                                       QMessageBox::Yes,QMessageBox::No ) == QMessageBox::Yes )
            {
                cDlgPatientCardSell obDlgPatientCardSell( this, &obDBPatientCard );
                obDlgPatientCardSell.setPatientCardOwner( g_obGuest.id() );
                obDlgPatientCardSell.exec();
            }
        }
    }
    catch( cSevException &e )
    {
        if( QString(e.what()).compare("Patientcard barcode not found") != 0 )
        {
            g_obLogger(e.severity()) << e.what() << EOM;
        }
        else
        {
            if( QMessageBox::question( this, tr("Question"),
                                       tr("This barcode has not found in the database.\n"
                                          "Do you want to save it and sell it now?"),
                                       QMessageBox::Yes,QMessageBox::No ) == QMessageBox::Yes )
            {
                obDBPatientCard.createNew();
                obDBPatientCard.setLicenceId( g_poPrefs->getLicenceId() );
                obDBPatientCard.setBarcode( p_stBarcode );
                obDBPatientCard.save();

                cDlgPatientCardSell obDlgPatientCardSell( this, &obDBPatientCard );
                obDlgPatientCardSell.setPatientCardOwner( g_obGuest.id() );
                obDlgPatientCardSell.exec();
//                processInputPatientCard( p_stBarcode );
            }
        }
    }
}
//====================================================================================
void cWndMain::processInputProduct( QString p_stBarcode )
{
    on_action_SellProduct_triggered( p_stBarcode );
}
//====================================================================================
void cWndMain::processInputTimePeriod( int p_inMinute )
{
    if( !mdiPanels->isCanBeStartedByTime() )
    {
        switch( customMsgBox( this, MSG_ATTENTION,
                              tr("Reset device|Add to wait list ...|Cancel"),
                              tr("This device already prepared with a time period."),
                              tr("To start the device with other conditions, please\n"
                                 "reset the device first with pushing the ESC button.") ) )
        {
            case 1:
                if( mdiPanels->isStatusCanBeReseted() )
                {
                    m_lblStatusLeft.setText( m_qsStatusText );
                    mdiPanels->clear();
                }
                else
                {
                    return;
                }
                break;
            case 2:
                on_action_UseDeviceLater_triggered();
                return;
                break;
            case 3:
            default:
                return;
        }
    }

    m_inPanelStartMinute = p_inMinute;
    on_action_UseDevice_triggered();

/*    if( mdiPanels->isHasToPay() )
    {
        QMessageBox::warning( this, tr("Warning"),
                              tr("The device usage has to be payed.\n"
                                 "Please process the payment first.") );
        return;
    }

    int inPrice;
    int inCount;

    mdiPanels->isTimeIntervallValid( p_inSecond, &inPrice, &inCount );
    if( inCount > 0 )
    {
        if( inCount > 1 )
        {
            cDlgPanelUseSelect  obDlgPanelUseSelect( this, mdiPanels->activePanelId(), p_inSecond );

            if( obDlgPanelUseSelect.exec() == QDialog::Accepted )
            {
                inPrice = obDlgPanelUseSelect.getPanelUsePrice();
            }
            else
            {
                return;
            }
        }

        mdiPanels->setMainProcessTime( p_inSecond*60, inPrice );
    }
    else
    {
        QMessageBox::warning( this, tr("Warning"),
                              tr("This time period did not saved in the database\n"
                                 "for the actually selected device.") );
    }*/
}
//====================================================================================
void cWndMain::on_action_EditActualPatient_triggered()
{
    m_dlgProgress->showProgress();

    cDlgGuestEdit  obDlgEdit( this, &g_obGuest );
    obDlgEdit.setWindowTitle( g_obGuest.name() );

    m_dlgProgress->hideProgress();

    obDlgEdit.exec();
}
//====================================================================================
void cWndMain::on_action_DeviceSettings_triggered()
{
    m_dlgProgress->showProgress();

    cDlgPanelSettings   obDlgEdit( this, mdiPanels->activePanelId() );

    m_dlgProgress->hideProgress();

    if( obDlgEdit.exec() == QDialog::Accepted )
    {
        mdiPanels->reload();
        g_obLogger(cSeverity::DEBUG) << QString::number( mdiPanels->activePanel() ) << EOM;
        m_dlgSecondaryWindow->refreshTitle( mdiPanels->activePanel() );
    }
}
//====================================================================================
void cWndMain::on_action_PayCash_triggered()
{
    if( !g_obCassa.isCassaEnabled() )
    {
        QMessageBox::warning( this, tr("Attention"),
                              tr("Cassa is disabled!\n\n"
                                 "Please relogin to enable cassa.") );
        return;
    }

    int                 inPriceTotal;
    int                 inPriceNet;
    int                 inPriceDiscount;
    unsigned int        uiPatientId;

    mdiPanels->getPanelCashData( &uiPatientId, &inPriceNet, &inPriceDiscount );

    cCurrency cPrice( inPriceNet, cCurrency::CURR_GROSS, g_poPrefs->getDeviceUseVAT() );

    inPriceTotal = cPrice.currencyValue().toInt() - inPriceDiscount;

    cDBShoppingCart obDBShoppingCart;

    obDBShoppingCart.setLicenceId( g_poPrefs->getLicenceId() );
    obDBShoppingCart.setGuestId( g_obGuest.id() );
    obDBShoppingCart.setProductId( 0 );
    obDBShoppingCart.setPatientCardId( 0 );
    obDBShoppingCart.setPatientCardTypeId( 0 );
    obDBShoppingCart.setPanelId( mdiPanels->activePanelId() );
    obDBShoppingCart.setLedgerTypeId( cDBLedger::LT_DEVICE_USAGE );
    obDBShoppingCart.setItemName( tr("Using panel") );
    obDBShoppingCart.setItemCount( 1 );
    obDBShoppingCart.setItemNetPrice( cPrice.currencyValue().toInt() );
    obDBShoppingCart.setItemVAT( g_poPrefs->getDeviceUseVAT() );
    obDBShoppingCart.setItemDiscount( inPriceDiscount );
    obDBShoppingCart.setItemSumPrice( inPriceTotal );

    cDlgCassaAction     obDlgCassaAction( this, &obDBShoppingCart );

    obDlgCassaAction.setPayWithCash();

    int             inCassaAction   = obDlgCassaAction.exec();
    int             inPayType       = 0;
    QString         qsComment       = tr("Using device: %1").arg( mdiPanels->getActivePanelCaption() );
    bool            bShoppingCart   = false;
    unsigned int    uiCouponId = 0;
    cDBDiscount     obDBDiscount;

    obDlgCassaAction.cassaResult( &inPayType, &bShoppingCart, &uiCouponId );

    if( inCassaAction == QDialog::Accepted && !bShoppingCart )
    {
        if( uiCouponId > 0 )
        {
            obDBDiscount.load( uiCouponId );

            obDBShoppingCart.setItemDiscount( obDBShoppingCart.itemDiscount()+obDBDiscount.discount(obDBShoppingCart.itemSumPrice()) );
        }
        unsigned int uiLedgerId = g_obCassa.cassaProcessDeviceUse( obDBShoppingCart, qsComment, inPayType, mdiPanels->getPanelCaption(obDBShoppingCart.panelId()) );
        processDeviceUsePayment( obDBShoppingCart.panelId(), uiLedgerId, inPayType );
    }
    else if( inCassaAction == QDialog::Accepted && bShoppingCart )
    {
        mdiPanels->itemAddedToShoppingCart();
        mdiPanels->cashPayed( 0 );
    }
}
//====================================================================================
void cWndMain::processDeviceUsePayment( unsigned int p_uiPanelId, unsigned int p_uiLedgerId, int p_nPaymentType )
{
    mdiPanels->setPaymentMethod( p_uiPanelId, p_nPaymentType );
    mdiPanels->cashPayed( p_uiPanelId, p_uiLedgerId );
    mdiPanels->itemRemovedFromShoppingCart( p_uiPanelId );
}
//====================================================================================
void cWndMain::processProductSellPayment( const cDBShoppingCart &p_obDBShoppingCart )
{
    cDBShoppingCart obDBShoppingCart = p_obDBShoppingCart;

    cDlgCassaAction     obDlgCassaAction( this, &obDBShoppingCart );

    obDlgCassaAction.setPayWithCash();

    int             inCassaAction   = obDlgCassaAction.exec();
    int             inPayType = 0;
    QString         qsComment = tr("Selling product: %1").arg( obDBShoppingCart.itemName() );
    bool            bShoppingCart = false;
    unsigned int    uiCouponId = 0;
    cDBDiscount     obDBDiscount;

    obDlgCassaAction.cassaResult( &inPayType, &bShoppingCart, &uiCouponId );

    if( inCassaAction == QDialog::Accepted && !bShoppingCart )
    {
        if( uiCouponId > 0 )
        {
            obDBDiscount.load( uiCouponId );

            obDBShoppingCart.setItemDiscount( obDBShoppingCart.itemDiscount()+obDBDiscount.discount(obDBShoppingCart.itemSumPrice()) );
        }
        g_obCassa.cassaProcessProductSell( p_obDBShoppingCart, qsComment, inPayType );
    }
}
//====================================================================================
void cWndMain::on_action_CassaHistory_triggered()
//====================================================================================
{
    m_dlgProgress->showProgress();

    cDlgReportCassaList  obDlgReportCassaList( this );

    m_dlgProgress->hideProgress();

    obDlgReportCassaList.exec();
}
//====================================================================================
void cWndMain::on_action_ReportPatientcardUses_triggered()
//====================================================================================
{
    m_dlgProgress->showProgress();

    cDlgReportCardUses  obDlgReportCardUses( this );

    m_dlgProgress->hideProgress();

    obDlgReportCardUses.exec();
}
//====================================================================================
void cWndMain::on_action_EditLicenceInformation_triggered()
//====================================================================================
{
    dlgLicenceEdit  obDlgLicenceEdit( this );

    obDlgLicenceEdit.exec();
}
//====================================================================================
void cWndMain::on_action_ReportPatientcards_triggered()
//====================================================================================
{
    m_dlgProgress->showProgress();

    cDlgReportPatientCard  obDlgReportPatientCard( this );

    m_dlgProgress->hideProgress();

    obDlgReportPatientCard.exec();
}
//====================================================================================
void cWndMain::on_action_Discounts_triggered()
//====================================================================================
{
    m_dlgProgress->showProgress();

    cDlgDiscount  obDlgDiscount( this );

    m_dlgProgress->hideProgress();

    obDlgDiscount.exec();
}
//====================================================================================
void cWndMain::on_action_PatientcardsObsolete_triggered()
//====================================================================================
{
    m_dlgProgress->showProgress();

    cDlgReportPatientCardObs  obDlgReportPatientCardObs( this );

    m_dlgProgress->hideProgress();

    obDlgReportPatientCardObs.exec();
}
//====================================================================================
void cWndMain::on_action_EmptyDemoDB_triggered()
//====================================================================================
{
    m_dlgProgress->showProgress();

    try
    {
        g_poDB->executeQTQuery( QString( "DELETE FROM ledger WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM ledgerDevice WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM cassaDenominations WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM cassaHistory WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM cassa WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM address WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM zipRegionCity WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM discounts WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM products WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM productTypes WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM patientCardHistories WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM connectPatientWithCard WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM patientCards WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM patientCardTypes WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM patients WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM companies WHERE licenceId=1" ) );
        g_poDB->executeQTQuery( QString( "DELETE FROM users WHERE licenceId=1 and userId>2" ) );

        m_dlgProgress->hideProgress();

        QMessageBox::information( this, tr("Information"),
                                  tr("Deleting data attached to DEMO licence key has been finished."));
    }
    catch( cSevException &e )
    {
        m_dlgProgress->hideProgress();

        g_obLogger(e.severity()) << e.what() << EOM;
    }
}
//====================================================================================
void cWndMain::slotStatusChanged( unsigned int p_uiPanelId, const unsigned int p_uiPanelStatusId, const QString p_qsStatus )
{
    m_dlgSecondaryWindow->setPanelStatus( p_uiPanelId, p_uiPanelStatusId );
    m_dlgSecondaryWindow->setPanelStatusText( p_uiPanelId, p_qsStatus );
}
//====================================================================================
void cWndMain::slotSetCounterText( unsigned int p_uiPanelId, const QString &p_qsCounter )
{
    m_dlgSecondaryWindow->setCounterText( p_uiPanelId, p_qsCounter );
}
//====================================================================================
void cWndMain::slotSetWaitTime( unsigned int p_uiPanelId, const unsigned int p_uiWaitTime )
{
    m_dlgSecondaryWindow->setPanelWaitTime( p_uiPanelId, p_uiWaitTime );
}
//====================================================================================
void cWndMain::slotSetInfoText( unsigned int p_uiPanelId, const QString &p_qsInfo )
{
    m_dlgSecondaryWindow->setPanelInfoText( p_uiPanelId, p_qsInfo );
}
//====================================================================================
void cWndMain::slotReplacePatientCard(const QString &p_qsBarcode)
{
    m_dlgProgress->showProgress();

    cDBPatientCard  obDBPatientCardOld;

    obDBPatientCardOld.load( p_qsBarcode );

    QMessageBox::warning( this, tr("Request"), tr("Please enter the new patientcard's barcode.") );

    cDlgInputStart  obDlgInputStart( this );

    obDlgInputStart.m_bCard = true;
    obDlgInputStart.init();

    m_dlgProgress->hideProgress();

    if( obDlgInputStart.exec() == QDialog::Accepted )
    {
        cDBPatientCard  obDBPatientCardNew;
        try
        {
            obDBPatientCardNew.load( obDlgInputStart.getEditText() );

            if( obDBPatientCardNew.pincode().compare("LOST") == 0 )
            {
                QMessageBox::warning( this, tr("Attention"),
                                      tr("This patientcard has been lost and replaced\nand can not be used or sold again.") );
                return;
            }
        }
        catch( cSevException &e )
        {
            if( QString(e.what()).compare("Patientcard barcode not found") != 0 )
            {
                g_obLogger(e.severity()) << e.what() << EOM;
            }
            else
            {
                if( QMessageBox::question( this, tr("Question"),
                                           tr("This barcode has not found in the database.\n"
                                              "Do you want to register it for a new patientcard?"),
                                           QMessageBox::Yes,QMessageBox::No ) == QMessageBox::Yes )
                {
                    obDBPatientCardNew.createNew();
                    obDBPatientCardNew.setLicenceId( g_poPrefs->getLicenceId() );
                    obDBPatientCardNew.setBarcode( obDlgInputStart.getEditText() );
                    obDBPatientCardNew.save();
                }
            }
        }

        if( obDBPatientCardNew.active() )
        {
            QMessageBox::warning( this, tr("Warning"), tr("This patientcard already in use.\n"
                                                          "Please select a non-active patientcard.") );
            return;
        }
        else
        {
            obDBPatientCardNew.setActive( true );
            obDBPatientCardNew.setPatientCardTypeId( obDBPatientCardOld.patientCardTypeId() );
            obDBPatientCardNew.setParentId( obDBPatientCardOld.parentId() );
            obDBPatientCardNew.setPatientId( obDBPatientCardOld.patientId() );
            obDBPatientCardNew.setUnits( obDBPatientCardOld.units() );
            obDBPatientCardNew.setTimeLeftStr( obDBPatientCardOld.timeLeftStr() );
            obDBPatientCardNew.setValidDateFrom( obDBPatientCardOld.validDateFrom() );
            obDBPatientCardNew.setValidDateTo( obDBPatientCardOld.validDateTo() );
            obDBPatientCardNew.setComment( obDBPatientCardOld.comment() );

            cCurrency cPrice( QString::number(g_poPrefs->getPatientCardLostPrice()/100) );

            cDBShoppingCart obDBShoppingCart;

            obDBShoppingCart.setLicenceId( g_poPrefs->getLicenceId() );
            obDBShoppingCart.setGuestId( obDBPatientCardNew.patientId() );
            obDBShoppingCart.setProductId( 0 );
            obDBShoppingCart.setPatientCardId( obDBPatientCardNew.id() );
            obDBShoppingCart.setPatientCardTypeId( obDBPatientCardNew.patientCardTypeId() );
            obDBShoppingCart.setPanelId( 0 );
            obDBShoppingCart.setLedgerTypeId( cDBLedger::LT_PC_LOST_REPLACE );
            obDBShoppingCart.setItemName( QString("%1 -> %2").arg(obDBPatientCardOld.barcode()).arg(obDBPatientCardNew.barcode()) );
            obDBShoppingCart.setItemCount( 1 );
            obDBShoppingCart.setItemNetPrice( cPrice.currencyValue().toInt() );
            obDBShoppingCart.setItemVAT( g_poPrefs->getPatientCardLostPriceVat() );
            obDBShoppingCart.setItemDiscount( 0 );
            obDBShoppingCart.setItemSumPrice( cPrice.currencyValue().toInt() );

            cDlgCassaAction     obDlgCassaAction( this, &obDBShoppingCart );

            obDlgCassaAction.setPayWithCash();

            int             inCassaAction   = obDlgCassaAction.exec();
            int             inPayType       = 0;
            QString         qsComment       = tr("Replace patientcard [%1]->[%2]").arg(obDBPatientCardOld.barcode()).arg(obDBPatientCardNew.barcode());
            bool            bShoppingCart   = false;
            unsigned int    uiCouponId = 0;
            cDBDiscount     obDBDiscount;

            obDlgCassaAction.cassaResult( &inPayType, &bShoppingCart, &uiCouponId );

            if( inCassaAction == QDialog::Accepted && !bShoppingCart )
            {
                if( uiCouponId > 0 )
                {
                    obDBDiscount.load( uiCouponId );

                    obDBShoppingCart.setItemDiscount( obDBShoppingCart.itemDiscount()+obDBDiscount.discount(obDBShoppingCart.itemSumPrice()) );
                }
                g_obCassa.cassaProcessPatientCardSell( obDBPatientCardNew, obDBShoppingCart, qsComment, true, inPayType );
            }
            else if( inCassaAction != QDialog::Accepted )
            {
                // Nem tortent meg az eladas
                return;
            }

            cDBPatientcardUnit  obDBPatientcardUnit;

            obDBPatientCardNew.save();
            obDBPatientcardUnit.setPatientCardId( obDBPatientCardOld.id() );
            obDBPatientcardUnit.replacePatientCard( obDBPatientCardNew.id() );

            // Nem kell trlni a krtyt, csak jelezni, hogy elveszett
            /*
            obDBPatientCardOld.setPatientCardTypeId( 0 );
            obDBPatientCardOld.setParentId( 0 );
            obDBPatientCardOld.setPatientId( 0 );
            obDBPatientCardOld.setUnits( 0 );
            obDBPatientCardOld.setAmount( 0 );
            obDBPatientCardOld.setTimeLeft( 0 );
            obDBPatientCardOld.setValidDateFrom( "2000-01-01" );
            obDBPatientCardOld.setValidDateTo( "2000-01-01" );
            */
            obDBPatientCardOld.setComment( tr("Lost and replaced with card: %1").arg(obDBPatientCardNew.barcode()) );
            obDBPatientCardOld.setPincode( "LOST" );
            obDBPatientCardOld.setActive( false );
            obDBPatientCardOld.save();
        }
    }
}
//====================================================================================
void cWndMain::slotAssignPartnerCard( const QString &p_qsBarcode )
{
    cTracer obTracer( "cWndMain::slotAssignPartnerCard" );

    cDlgPatientCardAssign obDlgPatientCardAssign( this, p_qsBarcode );

    if( obDlgPatientCardAssign.exec() == QDialog::Accepted )
    {
        QString qsBarcodeMain;
        QString qsBarcodeAssign;

        obDlgPatientCardAssign.getCardsBarcode( &qsBarcodeMain, &qsBarcodeAssign );

        try
        {
            cDBPatientCard  obDBPatientCardMain;
            cDBPatientCard  obDBPatientCardAssign;

            obDBPatientCardMain.load( qsBarcodeMain );
            obDBPatientCardAssign.load( qsBarcodeAssign );

            if( obDBPatientCardAssign.active() )
            {
                if( QMessageBox::question( this, tr("Question"),
                                           tr("Are you sure about to merge these patientcards?\n"
                                              "Main card: %1\n"
                                              "Assigned card: %2").arg( obDBPatientCardMain.barcode() ).arg( obDBPatientCardAssign.barcode() ),
                                           QMessageBox::Yes,QMessageBox::No ) == QMessageBox::Yes )
                {
                    obDBPatientCardMain.setUnits( obDBPatientCardMain.units()+obDBPatientCardAssign.units() );
                    obDBPatientCardMain.save();

                    obDBPatientCardAssign.setParentId( obDBPatientCardMain.id() );
                    obDBPatientCardAssign.setUnits( obDBPatientCardMain.units() );
                    obDBPatientCardAssign.setComment( tr("Partner card of \"%1\"").arg(obDBPatientCardMain.barcode()) );
                    obDBPatientCardAssign.save();

                    cDBPatientcardUnit  obDBPatientcardUnit;

                    obDBPatientcardUnit.setPatientCardId( obDBPatientCardAssign.id() );
                    obDBPatientcardUnit.replacePatientCard( obDBPatientCardMain.id() );
                }
            }
            else
            {
                obDBPatientCardAssign.setActive( true );
                obDBPatientCardAssign.setPatientCardTypeId( obDBPatientCardMain.patientCardTypeId() );
                obDBPatientCardAssign.setParentId( obDBPatientCardMain.id() );
                obDBPatientCardAssign.setPatientId( 0 );
                obDBPatientCardAssign.setUnits( obDBPatientCardMain.units() );
                obDBPatientCardAssign.setTimeLeftStr( obDBPatientCardMain.timeLeftStr() );
                obDBPatientCardAssign.setValidDateFrom( obDBPatientCardMain.validDateFrom() );
                obDBPatientCardAssign.setValidDateTo( obDBPatientCardMain.validDateTo() );
                obDBPatientCardAssign.setComment( tr("Partner card of \"%1\"").arg(obDBPatientCardMain.barcode()) );

                cCurrency cPrice( QString::number(g_poPrefs->getPatientCardPartnerPrice()/100) );

                cDBShoppingCart obDBShoppingCart;

                obDBShoppingCart.setLicenceId( g_poPrefs->getLicenceId() );
                obDBShoppingCart.setGuestId( obDBPatientCardAssign.patientId() );
                obDBShoppingCart.setProductId( 0 );
                obDBShoppingCart.setPatientCardId( obDBPatientCardAssign.id() );
                obDBShoppingCart.setPatientCardTypeId( obDBPatientCardAssign.patientCardTypeId() );
                obDBShoppingCart.setPanelId( 0 );
                obDBShoppingCart.setLedgerTypeId( cDBLedger::LT_PC_ASSIGN_PARTNER );
                obDBShoppingCart.setItemName( QString("%1 -> %2").arg(obDBPatientCardMain.barcode()).arg(obDBPatientCardAssign.barcode()) );
                obDBShoppingCart.setItemCount( 1 );
                obDBShoppingCart.setItemNetPrice( cPrice.currencyValue().toInt() );
                obDBShoppingCart.setItemVAT( g_poPrefs->getPatientCardLostPriceVat() );
                obDBShoppingCart.setItemDiscount( 0 );
                obDBShoppingCart.setItemSumPrice( cPrice.currencyValue().toInt() );

                cDlgCassaAction     obDlgCassaAction( this, &obDBShoppingCart );

                obDlgCassaAction.setPayWithCash();

                int             inCassaAction   = obDlgCassaAction.exec();
                int             inPayType       = 0;
                QString         qsComment       = tr("Assign patientcard [%1]<-[%2]").arg(obDBPatientCardMain.barcode()).arg(obDBPatientCardAssign.barcode());
                bool            bShoppingCart   = false;
                unsigned int    uiCouponId = 0;
                cDBDiscount     obDBDiscount;

                obDlgCassaAction.cassaResult( &inPayType, &bShoppingCart, &uiCouponId );

                if( inCassaAction == QDialog::Accepted && !bShoppingCart )
                {
                    if( uiCouponId > 0 )
                    {
                        obDBDiscount.load( uiCouponId );

                        obDBShoppingCart.setItemDiscount( obDBShoppingCart.itemDiscount()+obDBDiscount.discount(obDBShoppingCart.itemSumPrice()) );
                    }
                    g_obCassa.cassaProcessPatientCardSell( obDBPatientCardAssign, obDBShoppingCart, qsComment, true, inPayType );
                }
                else if( inCassaAction != QDialog::Accepted )
                {
                    // Nem tortent meg az eladas
                    return;
                }

                obDBPatientCardAssign.save();
            }
        }
        catch( cSevException &e )
        {
            g_obLogger(e.severity()) << e.what() << EOM;
        }
    }
}

void cWndMain::on_action_PaymentMethods_triggered()
{
    m_dlgProgress->showProgress();

    cDlgPaymentMethod   obDlgPaymentMethod( this );

    m_dlgProgress->hideProgress();

    obDlgPaymentMethod.exec();
}

void cWndMain::on_action_TestDlgStarted()
{
    cDlgTest    obDlgTest( this );

    obDlgTest.exec();
}


void cWndMain::on_ledPassword_returnPressed()
{
    on_pbLogin_clicked();
}

void cWndMain::on_action_ReportViewer_triggered()
{
    QProcess *qpReportViewer = new QProcess(this);

    if( !qpReportViewer->startDetached( QString("ReportViewer.exe %1 %2").arg(g_obUser.name()).arg(ledPassword->text()) ) )
    {
        QMessageBox::warning( this, tr("Warning"),
                              tr("Error occured when starting process:ReportViewer.exe\n\nError code: %1\n"
                                 "0 > The process failed to start.\n"
                                 "1 > The process crashed some time after starting successfully.\n"
                                 "2 > The last waitFor...() function timed out.\n"
                                 "4 > An error occurred when attempting to write to the process.\n"
                                 "3 > An error occurred when attempting to read from the process.\n"
                                 "5 > An unknown error occurred.").arg(qpReportViewer->error()) );
    }
}

void cWndMain::on_action_About_triggered()
{
    QSqlQuery *poQuery = g_poDB->executeQTQuery( QString( "SELECT * FROM licences WHERE licenceId=%1" ).arg( g_poPrefs->getLicenceId() ) );
    poQuery->first();

    QMessageBox::information( this, tr("About"),
                              tr("<h2>Belenus Software Application System</h2>"
                                 "<p>"
                                 "Version : %1"
                                 "<p>"
                                 "Copyright 2013 Tamas Bikfalvi. All rights reserved."
                                 "<p>"
                                 "Application Licence : %2"
                                 "<p>"
                                 "The application and all of its related products<br>"
                                 "is the property of KiwiSun Franchise.<br>"
                                 "For more information visit the <a href=\"http://www.kiwisun.eu\">KiwiSun website</a>"
                                 ).arg( g_poPrefs->getVersion() ).arg( poQuery->value( 1 ).toString() ) );
}
//====================================================================================
int cWndMain::customMsgBox(QWidget *parent, msgBoxType msgtype, QString buttonstext, QString msg, QString details)
//====================================================================================
{
    QMessageBox msgBox;

    switch(msgtype)
    {
        case MSG_INFORMATION:
            msgBox.setWindowTitle( QObject::tr("Information") );
            msgBox.setIcon( QMessageBox::Information );
            break;
        case MSG_WARNING:
            msgBox.setWindowTitle( QObject::tr("Warning") );
            msgBox.setIcon( QMessageBox::Warning );
            break;
        case MSG_ATTENTION:
            msgBox.setWindowTitle( QObject::tr("Attention") );
            msgBox.setIcon( QMessageBox::Warning );
            break;
        case MSG_ERROR:
            msgBox.setWindowTitle( QObject::tr("Error") );
            msgBox.setIcon( QMessageBox::Critical );
            break;
        case MSG_QUESTION:
            msgBox.setWindowTitle( QObject::tr("Question") );
            msgBox.setIcon( QMessageBox::Question );
            break;
    }

    msgBox.setText( msg );
    if( details.length() > 0 ) msgBox.setDetailedText( details );

    QList<QPushButton*> qlButtons;
    QStringList         qslButtons = buttonstext.split('|');

    for( int i=0; i<qslButtons.size(); i++ )
    {
        QPushButton *pButton = msgBox.addButton( qslButtons.at(i), QMessageBox::ActionRole );
        qlButtons.append( pButton );
    }

    msgBox.exec();

    int nRet = 0;

    for( int i=0; i<qslButtons.size(); i++ )
    {
        if( msgBox.clickedButton() == (QAbstractButton*)qlButtons.at(i) )
        {
            nRet = i+1;
            break;
        }
    }

    return nRet;
}
